image: python:3.11

variables:
  UV_VERSION: "0.9.18"
  UV_CACHE_DIR: ".cache/uv"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

stages:
  - lint
  - release

cache:
  paths:
    - .cache/uv

# -------------------------
# Base setup
# -------------------------
.before_uv:
  before_script:
    - pip install uv
    - uv sync --dev

# -------------------------
# LINTING
# -------------------------
lint:
  stage: lint
  extends: .before_uv
  script:
    - uv run ruff check cli core
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# -------------------------
# RELEASE (Auto-Versioning & Build)
# -------------------------
release:
  stage: release
  extends: .before_uv
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  script:
    # 1. Configuraci贸n de Git
    - git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git config user.name "$GITLAB_USER_NAME"
    - git config user.email "$GITLAB_USER_EMAIL"
    
    - TARGET_BRANCH=${CI_COMMIT_BRANCH:-$CI_DEFAULT_BRANCH}
    - git checkout -B $TARGET_BRANCH
    - git pull origin $TARGET_BRANCH


    - uv run cz bump --prerelease alpha --yes --changelog || (echo "No hay cambios para subir de versi贸n" && exit 0)
    

    - git push origin $TARGET_BRANCH --tags


    - rm -rf dist/
    - uv build
    

    - VERSION=$(uv run cz version --project)
    - |
      python3 -c "
      import pathlib, re, os, json
      version = os.getenv('VERSION', '')
      dist_path = pathlib.Path('dist')
      
      # Buscamos el whl y tar.gz reales
      whl_files = list(dist_path.glob('*.whl'))
      tar_files = list(dist_path.glob('*.tar.gz'))
      
      whl_name = whl_files[0].name if whl_files else ''
      tar_name = tar_files[0].name if tar_files else ''

      description = f'### Release {version}\n\nNueva versi贸n alpha del pipeline.'
      try:
          if pathlib.Path('CHANGELOG.md').exists():
              content = pathlib.Path('CHANGELOG.md').read_text(encoding='utf-8')
              # Extraer la secci贸n del changelog para esta versi贸n espec铆fica
              pattern = r'## (v?)' + re.escape(version) + r'.*?(?=\n## |$)'
              match = re.search(pattern, content, re.DOTALL)
              if match:
                  description = match.group(0).strip()
      except Exception as e:
          print(f'Aviso: No se pudo procesar el changelog: {e}')

      payload = {
          'name': f'Release {version}',
          'tag_name': f'v{version}',
          'description': description,
          'assets': {
              'links': [
                  {
                      'name': ' Python Wheel',
                      'url': f'{os.getenv(\"CI_PROJECT_URL\")}/-/jobs/{os.getenv(\"CI_JOB_ID\")}/artifacts/raw/dist/{whl_name}'
                  },
                  {
                      'name': 'Source Tarball',
                      'url': f'{os.getenv(\"CI_PROJECT_URL\")}/-/jobs/{os.getenv(\"CI_JOB_ID\")}/artifacts/raw/dist/{tar_name}'
                  }
              ]
          }
      }
      with open('release_data.json', 'w') as f:
          json.dump(payload, f)
      "


    - sleep 5
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data @release_data.json \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"

  artifacts:
    paths:
      - dist/
    expire_in: never
  rules:

    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_COMMIT_MESSAGE !~ /bump: version|chore\(release\):/'
      when: on_success