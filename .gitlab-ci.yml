image: python:3.11

variables:
  UV_VERSION: "0.9.18"
  UV_CACHE_DIR: ".cache/uv"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

stages:
  - lint
  - release

cache:
  paths:
    - .cache/uv

.before_uv:
  before_script:
    - pip install uv
    - uv sync --dev

lint:
  stage: lint
  extends: .before_uv
  script:
    - uv run ruff check cli core
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

release:
  stage: release
  extends: .before_uv
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  script:
    # 1. Configuraci贸n de Git
    - git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git config user.name "$GITLAB_USER_NAME"
    - git config user.email "$GITLAB_USER_EMAIL"
    
    - TARGET_BRANCH=${CI_COMMIT_BRANCH:-$CI_DEFAULT_BRANCH}
    - git checkout -B $TARGET_BRANCH
    - git pull origin $TARGET_BRANCH

    # 2. Bump de versi贸n forzado
    - |
      echo "Incrementando versi贸n..."
      uv run cz bump --prerelease alpha --yes --changelog || \
      uv run cz bump --prerelease alpha --increment PATCH --yes --changelog || \
      echo "Ignorando error de historial."

    # 3. Extraer la versi贸n ACTUALIZADA del archivo
    - NEW_VERSION=$(grep -m 1 'version =' pyproject.toml | tr -d '"' | tr -d ' ' | cut -d '=' -f2)
    - echo "Nueva versi贸n detectada -> $NEW_VERSION"
    
    # 4. Guardar cambios en Git
    - git add .
    - |
      if git diff --cached --quiet; then
        echo "Sin cambios en archivos."
      else
        git commit -m "chore(release): v$NEW_VERSION [skip ci]"
      fi
    - git tag -f "v$NEW_VERSION" -m "Release v$NEW_VERSION"
    - git push origin $TARGET_BRANCH --tags --force

    # 5. Build
    - rm -rf dist/
    - uv build

    # 6. Preparar JSON para Release (Python)
    - |
      python3 -c "
      import pathlib, os, json
      version = os.getenv('NEW_VERSION', '')
      dist_path = pathlib.Path('dist')
      whl_file = next(dist_path.glob('*.whl')).name if list(dist_path.glob('*.whl')) else ''

      payload = {
          'name': f'Release {version}',
          'tag_name': f'v{version}',
          'ref': os.getenv('CI_COMMIT_SHA'),
          'description': f'Xolo Pipeline Alpha v{version} - Automated Build',
          'assets': {
              'links': [{
                  'name': ' Python Wheel',
                  'url': f'{os.getenv(\"CI_PROJECT_URL\")}/-/jobs/{os.getenv(\"CI_JOB_ID\")}/artifacts/raw/dist/{whl_file}'
              }]
          }
      }
      with open('release_data.json', 'w') as f:
          json.dump(payload, f, indent=4)
      "

    # 7. Crear Release (URL Corregida)
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data @release_data.json \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"

  artifacts:
    paths:
      - dist/
    expire_in: never
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_COMMIT_MESSAGE !~ /chore\(release\):|bump: version/'
      when: on_success