image: python:3.11

variables:
  UV_VERSION: "0.9.16"
  UV_CACHE_DIR: ".cache/uv"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

stages:
  - test
  - lint
  - review
  - release

cache:
  paths:
    - .cache/uv

# -------------------------
# Base setup
# -------------------------
.before_uv:
  before_script:
    - pip install uv
    - uv sync --dev
    - uv sync

# -------------------------
# TESTS
# -------------------------
test:
  stage: test
  extends: .before_uv
  variables:
    PIPELINE_ROOT: "/tmp/xolo-pipeline"
  script:
    - mkdir -p /tmp/xolo-pipeline
    - uv run --dev pytest -q tests
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: "$CI_COMMIT_BRANCH"

# -------------------------
# LINTING
# -------------------------
lint:
  stage: lint
  extends: .before_uv
  script:
    - uv run ruff check cli core
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: "$CI_COMMIT_BRANCH"

# -------------------------
# REVIEW (Merge Requests)
# -------------------------
review_pipeline:
  stage: review
  script:
    - echo "Review pipeline passed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# -------------------------
# RELEASE (Tags + Changelog automarically)
# -------------------------
release:
  stage: release
  extends: .before_uv
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0 # OBLIGATORIO para que cz vea los tags y commits previos
  script:
    - uv sync --dev

    # 1. Configurar Git con el Token
    - git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git config user.name "$GITLAB_USER_NAME"
    - git config user.email "$GITLAB_USER_EMAIL"

    # 2. Limpiar cualquier cambio local (como uv.lock modificado) y asegurar rama
    - git reset --hard HEAD
    - git checkout -B $CI_COMMIT_BRANCH
    - git pull origin $CI_COMMIT_BRANCH

    # 3. Ejecutar Bump
    # Usamos --check-consistency para asegurar que pyproject.toml y cz coincidan
    - uv run cz bump --yes --changelog

    # 4. Push de los cambios creados por CZ (el commit de release y el tag)
    - git push origin $CI_COMMIT_BRANCH --tags
    - rm -rf .cache/uv

    # 5. Build y API Release
    - uv run python -m build
    - NEW_VERSION=$(uv run cz version --project)
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{
          \"name\": \"Release $NEW_VERSION\",
          \"tag_name\": \"v$NEW_VERSION\",
          \"description\": \"Release generado autom√°ticamente por Commitizen\"
        }" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  artifacts:
    paths:
      - dist/
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_COMMIT_MESSAGE !~ /chore\(release\):/'
      when: manual
