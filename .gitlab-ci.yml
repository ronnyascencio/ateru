image: python:3.11

variables:
  UV_VERSION: "0.9.16"
  UV_CACHE_DIR: ".cache/uv"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

stages:
  - test
  - lint
  - review
  - release

cache:
  paths:
    - .cache/uv

# -------------------------
# Base setup
# -------------------------
.before_uv:
  before_script:
    - pip install uv
    - uv sync --extra dev

# -------------------------
# TESTS
# -------------------------
test:
  stage: test
  extends: .before_uv
  variables:
    PIPELINE_ROOT: "/tmp/xolo-pipeline"
  script:
    - mkdir -p /tmp/xolo-pipeline
    - uv run --dev pytest -q tests
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'


# -------------------------
# LINTING
# -------------------------
lint:
  stage: lint
  extends: .before_uv
  script:
    - uv run ruff check cli core
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

# -------------------------
# REVIEW (Merge Requests)
# -------------------------
review_pipeline:
  stage: review
  script:
    - echo "Review pipeline passed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# -------------------------
# RELEASE (Tags)
# -------------------------
release:
  stage: release
  extends: .before_uv
  script:
    - uv run python -m build
    - echo "Release build created for tag $CI_COMMIT_TAG"
  artifacts:
    paths:
      - dist/
  rules:
    - if: '$CI_COMMIT_TAG'
