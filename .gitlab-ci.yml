image: python:3.11

variables:
  UV_VERSION: "0.9.18"
  UV_CACHE_DIR: ".cache/uv"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

stages:
  - test
  - lint
  - review
  - release

cache:
  paths:
    - .cache/uv

# -------------------------
# Base setup
# -------------------------
.before_uv:
  before_script:
    - pip install uv
    - uv sync --dev

# -------------------------
# TESTS
# -------------------------
test:
  stage: test
  extends: .before_uv
  variables:
    PIPELINE_ROOT: "/tmp/xolo-pipeline"
  script:
    - mkdir -p /tmp/xolo-pipeline
    - uv run --dev pytest -q tests
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: "$CI_COMMIT_BRANCH"

# -------------------------
# LINTING
# -------------------------
lint:
  stage: lint
  extends: .before_uv
  script:
    - uv run ruff check cli core
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: "$CI_COMMIT_BRANCH"

# -------------------------
# REVIEW (Merge Requests)
# -------------------------
review_pipeline:
  stage: review
  script:
    - echo "Review pipeline passed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# -------------------------
# RELEASE (Nivel Profesional)
# -------------------------
release:
  stage: release
  extends: .before_uv
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  script:
    - pip install uv
    - uv sync --dev

    # 1. Configuraci贸n y Sincronizaci贸n Robusta
    - git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git config user.name "$GITLAB_USER_NAME"
    - git config user.email "$GITLAB_USER_EMAIL"
    - git reset --hard HEAD

    # Soluci贸n al error 'switch B requires a value'
    - TARGET_BRANCH=${CI_COMMIT_BRANCH:-$CI_DEFAULT_BRANCH}
    - git checkout -B $TARGET_BRANCH
    - git pull origin $TARGET_BRANCH

    # 2. Generaci贸n de Versi贸n y Tags
    - uv run cz bump --yes --changelog || echo "Skipping bump"
    - git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:$TARGET_BRANCH --tags

    # 3. Construcci贸n Limpia (Evita AbsoluteLinkError)
    - rm -rf .venv .cache
    - uv build

    # ... (despu茅s de uv build)
    - VERSION=$(uv run cz version --project)
    - export VERSION # <--- IMPORTANTE: Exportar para que Python la vea


      # 4. Extracci贸n de Changelog (Nivel Profesional)
    - |
      RELEASE_NOTES=$(python3 -c "
      import pathlib, re, os
      version = os.getenv('VERSION', '')
      try:
          content = pathlib.Path('CHANGELOG.md').read_text(encoding='utf-8')
          # Buscamos la secci贸n que empieza con la versi贸n hasta la siguiente o el fin de archivo
          pattern = r'## (v?)' + re.escape(version) + r'.*?(?=\n## |$)'
          match = re.search(pattern, content, re.DOTALL)
          if match:
              # Limpiamos y escapamos para el JSON del curl
              notes = match.group(0).strip().replace('\"', '\\\"').replace('\n', '\\n')
              print(notes)
          else:
              print(f'### Release {version}\\n\\nNuevas mejoras y correcciones aplicadas.')
      except Exception:
          print(f'### Release {version}')
      ")

      # 5. Publicaci贸n en GitLab
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{
          \"name\": \"Release $VERSION\",
          \"tag_name\": \"v$VERSION\",
          \"description\": \"$RELEASE_NOTES\",
          \"assets\": {
            \"links\": [
              {
                \"name\": \" Python Wheel (.whl)\",
                \"url\": \"${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/dist/xolo_pipeline-${VERSION}-py3-none-any.whl\"
              },
              {
                \"name\": \"Source Distribution (.tar.gz)\",
                \"url\": \"${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/dist/xolo_pipeline-${VERSION}.tar.gz\"
              }
            ]
          }
        }" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"

  artifacts:
    paths:
      - dist/
    expire_in: never
